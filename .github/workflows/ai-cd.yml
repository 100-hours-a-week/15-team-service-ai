name: CD (FastAPI deploy via SSH)

on:
  push:
    branches: [ "main", "cicd/ai1" ]
    
concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_ROOT: ${{ vars.APP_ROOT }}
          SERVICE_NAME: ${{ vars.SERVICE_NAME }}
          APP_ENV: prod
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script_stop: true
          command_timeout: 15m
          envs: APP_ENV,SECRET_KEY,APP_ROOT,SERVICE_NAME
          script: |
            set -euo pipefail

            APP_ROOT="${APP_ROOT:-/opt/myapi}"
            SERVICE_NAME="${SERVICE_NAME:-myapi}"

            REPO_DIR="$APP_ROOT/repo"
            VENV_DIR="$APP_ROOT/venv"
            ENV_FILE="$APP_ROOT/.env"
            
            HEALTH_URL="${HEALTH_URL:-http://127.0.0.1:8000/health}"
            HEALTH_TIMEOUT="${HEALTH_TIMEOUT:-30}"   # seconds
            HEALTH_INTERVAL=2

            echo "[1/5] write env file"
            cat > "$ENV_FILE" <<ENV
            APP_ENV=${APP_ENV}
            SECRET_KEY=${SECRET_KEY}
            ENV
            chmod 600 "$ENV_FILE"

            echo "[2/5] cd repo"
            cd "$REPO_DIR"

            echo "[3/5] checkout main & pull"
            git fetch origin
            git checkout main
            git pull --ff-only origin main

            echo "[4/5] install deps"
            export PATH="$HOME/.local/bin:$PATH"
            command -v uv
            uv --version

            cd "$REPO_DIR"
            uv sync --frozen

            echo "[4.5/5] SSM Parameter Store -> .env 생성..."
            sudo /usr/local/bin/render-env.sh

            echo "[5/5] restart service"
            sudo systemctl daemon-reload
            sudo systemctl restart "$SERVICE_NAME"
            sudo systemctl is-active --quiet "$SERVICE_NAME" || {
              sudo systemctl status "$SERVICE_NAME" --no-pager -l || true
              sudo journalctl -u "$SERVICE_NAME" -n 200 --no-pager || true
              exit 1
            }

            sleep 20
            
            echo "[6/6] health check"
            elapsed=0
            until curl -fsS "$HEALTH_URL" > /dev/null; do
              if [ "$elapsed" -ge "$HEALTH_TIMEOUT" ]; then
                echo "Health check failed after ${HEALTH_TIMEOUT}s"
                sudo systemctl status "$SERVICE_NAME" --no-pager || true
                sudo journalctl -u "$SERVICE_NAME" -n 200 --no-pager || true
                sudo ss -lntp | grep -E ':(8000)\b' || true
                exit 1
              fi
              sleep "$HEALTH_INTERVAL"
              elapsed=$((elapsed + HEALTH_INTERVAL))
            done

            echo "deploy done (branch=main)"

